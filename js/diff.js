var DiffCamEngine=function(){var t,o,e,n,i,a,r,c,m,s,d,l,u,f,x,h,v,g,p,y,C,D,B;function M(o){t=o,m()}function I(t){console.log(t),s()}function w(){o.removeEventListener("canplay",w),u=setInterval(b,f),d()}function b(){n.drawImage(o,0,0,x,h);var t=n.getImageData(0,0,x,h);a.globalCompositeOperation="difference",a.drawImage(o,0,0,v,g);var i=a.getImageData(0,0,v,g);if(p){var r=function(t){for(var o=t.data,e=0,n=B?[]:void 0,i=void 0,a=0;a<o.length;a+=4){var r=.3*o[a]+.6*o[a+1]+.1*o[a+2],c=Math.min(255,r*(255/y));o[a]=0,o[a+1]=c,o[a+2]=0,r>=y&&(e++,coords={x:(m=a/4)%v,y:Math.floor(m/v)},D&&(i=E(i,coords.x,coords.y)),B&&(n=P(n,coords.x,coords.y,r)))}var m;return{score:e,motionBox:e>C?i:void 0,motionPixels:n}}(i);c.putImageData(i,0,0),r.motionBox&&(c.strokeStyle="#fff",c.strokeRect(r.motionBox.x.min+.5,r.motionBox.y.min+.5,r.motionBox.x.max-r.motionBox.x.min,r.motionBox.y.max-r.motionBox.y.min)),l({imageData:t,score:r.score,hasMotion:r.score>=C,motionBox:r.motionBox,motionPixels:r.motionPixels,getURL:function(){return t=this.imageData,n.putImageData(t,0,0),e.toDataURL();var t},checkMotionPixel:function(t,o){return function(t,o,e){return t&&t[o]&&t[o][e]}(this.motionPixels,t,o)}})}a.globalCompositeOperation="source-over",a.drawImage(o,0,0,v,g),p=!0}function E(t,o,e){var n=t||{x:{min:coords.x,max:o},y:{min:coords.y,max:e}};return n.x.min=Math.min(n.x.min,o),n.x.max=Math.max(n.x.max,o),n.y.min=Math.min(n.y.min,e),n.y.max=Math.max(n.y.max,e),n}function P(t,o,e,n){return t[o]=t[o]||[],t[o][e]=!0,t}return{getPixelDiffThreshold:function(){return y},setPixelDiffThreshold:function(t){y=t},getScoreThreshold:function(){return C},setScoreThreshold:function(t){C=t},init:function(t){if(!t)throw"No options object provided";var u;o=t.video||document.createElement("video"),r=t.motionCanvas||document.createElement("canvas"),f=t.captureIntervalTime||0.1,x=t.captureWidth||64,h=t.captureHeight||48,v=t.diffWidth||64,g=t.diffHeight||48,y=t.pixelDiffThreshold||72,C=t.scoreThreshold||16,D=t.includeMotionBox||!1,B=t.includeMotionPixels||!1,m=t.initSuccessCallback||function(){},s=t.initErrorCallback||function(){},d=t.startCompleteCallback||function(){},l=t.captureCallback||function(){},e=document.createElement("canvas"),i=document.createElement("canvas"),p=!1,o.autoplay=!0,e.width=x,e.height=h,n=e.getContext("2d"),i.width=v,i.height=g,a=i.getContext("2d"),r.width=v,r.height=g,c=r.getContext("2d"),u={audio:!1,video:{width:x,height:h}},navigator.mediaDevices.getUserMedia(u).then(M).catch(I)},start:function(){if(!t)throw"Cannot start after init fail";o.addEventListener("canplay",w),o.srcObject=t},stop:function(){clearInterval(u),o.src="",c.clearRect(0,0,v,g),p=!1}}}();
